import { DataService } from '../../service/DataService';
import { FormCardData, FormData } from '../../common/CommonData';
import formProvider from '@kit.FormKit';

let storageLocal = new LocalStorage();

@Entry(storageLocal)
@Component
struct WidgetCard {
  @LocalStorageProp('formTime') @Watch('onFormTimeChange') formTime: string = '';
  @LocalStorageProp('formId') formId: string = '';
  @LocalStorageProp('cardList') @Watch('onCardListChange') cardList: FormCardData[] = [];
  @State currentData: FormCardData | null = null;
  @State animOpacity: number = 1;

  readonly fullWidthPercent: string = '100%';
  readonly fullHeightPercent: string = '100%';

  onFormTimeChange() {
    console.log('WidgetCard: formTime changed to', this.formTime);
    // formTimeå˜åŒ–è¡¨ç¤ºæ•°æ®å·²æ›´æ–°ï¼Œå¯ä»¥è§¦å‘é¢å¤–å¤„ç†
  }

   onCardListChange() {
    console.log('WidgetCard: cardList changed, length =', this.cardList?.length);

    // å…ˆå˜ä¸ºåŠé€æ˜ï¼ˆæ·¡å‡ºæ•ˆæœï¼‰
    this.animOpacity = 0.3;

    // ç«‹å³æ›´æ–°æ•°æ®
    if (this.cardList && this.cardList.length > 0) {
      this.currentData = this.cardList[0];
      console.log('WidgetCard: currentData set, id =', this.currentData?.id);
      console.log('WidgetCard: action_data =', this.currentData?.action_data);
    } else {
      console.log('WidgetCard: cardList is empty or undefined');
      this.currentData = null;
    }
    
    // ç„¶åæ¢å¤åˆ°ä¸é€æ˜ï¼ˆæ·¡å…¥æ•ˆæœï¼‰
    this.animOpacity = 1;
  }

  // ä¿ç•™onUpdateFormç”¨äºè°ƒè¯•ï¼Œä½†æ•°æ®ç°åœ¨é€šè¿‡LocalStorageè‡ªåŠ¨æ³¨å…¥
  onUpdateForm(formData: FormData) {
    console.log('WidgetCard: onUpdateForm called (legacy), formTime =', formData.formTime);
    console.log('WidgetCard: cardList from LocalStorage length =', this.cardList?.length);
    // æ•°æ®å·²é€šè¿‡LocalStorageæ³¨å…¥ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†
  }

  build() {
    Column() {
      Row() {
        // å·¦ä¾§ï¼šå›¾æ ‡å’Œæ ‡é¢˜
        Row() {
          Text('ğŸ¤–')
            .fontSize(18)
            .margin({ right: 8 })
          
          Text('Smart Actions')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
        }
        .layoutWeight(1)

        // å³ä¾§ï¼šçŠ¶æ€æŒ‡ç¤ºå™¨å’ŒåŠ¨ä½œç±»å‹
        Row() {
          // çŠ¶æ€æŒ‡ç¤ºå™¨
          Stack() {
            Circle()
              .width(10)
              .height(10)
              .fill(this.currentData ? '#52C41A' : '#FFA940')
              .opacity(this.currentData ? 0.8 : 0.6)
            
            if (!this.currentData) {
              Circle()
                .width(10)
                .height(10)
                .fill('#FFA940')
                .opacity(0.3)
                .scale({ x: 1.5, y: 1.5 })
            }
          }
          .margin({ right: 8 })

          // åŠ¨ä½œç±»å‹æ ‡ç­¾ï¼ˆå›¾æ ‡+æ–‡å­—ï¼‰
          if (this.currentData?.action_data) {
            Row() {
              Text(this.getActionTypeIcon(this.currentData.action_data.action_type))
                .fontSize(10)
                .margin({ right: 4 })
              
              Text(this.getActionTypeShortLabel(this.currentData.action_data.action_type))
                .fontSize(11)
                .fontWeight(FontWeight.Bold)
                .fontColor(DataService.getActionTypeLabelTextColor(this.currentData.action_data.action_type))
            }
            .padding({ left: 12, right: 12, top: 5, bottom: 5 })
            .backgroundColor(DataService.getActionTypeLabelBgColor(this.currentData.action_data.action_type))
            .borderRadius(20)
            .border({
              width: 1,
              color: this.getActionTypeBorderColor(this.currentData.action_data.action_type)
            })
          }
        }
        .alignItems(VerticalAlign.Center)
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .alignItems(VerticalAlign.Center)
      .padding({ top: 16, bottom: 12, left: 18, right: 18 })

      Row()
        .height(0.5)
        .width('100%')
        .backgroundColor('#E0E0E0')
        .margin({ left: 18, right: 18 })
        .opacity(0.4)

      Column({ space: 12 }) {
        if (this.currentData) {
          this.actionContent();
        } else {
          this.statusContent();
        }
      }
      .opacity(this.animOpacity)
      .animation({
        duration: 1000,
        curve: Curve.EaseOut
      })
      .margin({ left: 18, right: 18, top: 16, bottom: 12 })
      .layoutWeight(1)

       Row() {
         Text(this.currentData ? 'âœ“' : 'â³')
           .fontSize(10)
           .margin({ right: 4 })
         
         Text(this.getStatusText())
           .fontSize(10)
           .fontColor(this.currentData ? '#666666' : '#999999')
           .fontWeight(this.currentData ? FontWeight.Medium : FontWeight.Normal)
       }
       .justifyContent(FlexAlign.Center)
       .margin({ bottom: 12 })
       .width('100%')
       .opacity(0.8)
    }
    .width(this.fullWidthPercent)
    .height(this.fullHeightPercent)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#00000010',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
   actionContent() {
    Column({ space: 8 }) {
       if (this.currentData?.action_data) {

         // Action name (Primary Information)
        if (this.currentData.action_data.action_name && this.currentData.action_data.action_name !== 'NONE') {
          Column({ space: 6 }) {
            Row() {
               Text(this.getActionTypeIcon(this.currentData.action_data.action_type))
                .fontSize(12)
                .margin({ right: 8 })
              
              Text('ACTION')
                .fontSize(11)
                .fontColor('#666666')
                .fontWeight(FontWeight.Bold)
                .opacity(0.9)
            }
            
            Text(this.currentData.action_data.action_name)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#000000')
              .margin({ top: 4 })
          }
          .width('100%')
          .padding({ top: 12, bottom: 12, left: 14, right: 14 })
           .backgroundColor(this.getActionNameBgColor())
          .border({
            width: 2,
            color: this.getActionTypeBorderColor(this.currentData.action_data.action_type)
          })
          .borderRadius(10)
          .shadow({
            radius: 4,
            color: '#00000008',
            offsetX: 0,
            offsetY: 2
          })
        }

         // Scene category (Secondary Information)
         if (this.currentData.action_data.scene_category) {
          Column({ space: 4 }) {
            Row() {
              Text('ğŸ“')
                .fontSize(10)
                .margin({ right: 6 })
                .opacity(0.7)
              
              Text('SCENE')
                .fontSize(10)
                .fontColor('#888888')
                .fontWeight(FontWeight.Medium)
                .opacity(0.8)
            }
            
            Text(this.currentData.action_data.scene_category)
              .fontSize(13)
              .fontWeight(FontWeight.Medium)
              .fontColor('#666666')
              .margin({ top: 2 })
          }
          .width('100%')
          .padding({ top: 8, bottom: 8, left: 12, right: 12 })
          .backgroundColor('#FAFAFA')
          .borderRadius(8)
          .margin({ bottom: 2 })
        }

         // Image display (if available)
         if (this.currentData.action_data.image) {
          Column({ space: 8 }) {
            Row() {
              Text('ğŸ–¼ï¸')
                .fontSize(11)
                .margin({ right: 6 })
              
              Text('Preview')
                .fontSize(11)
                .fontColor('#666666')
                .fontWeight(FontWeight.Medium)
                .opacity(0.8)
            }
            
            Image(this.currentData.action_data.image)
              .width(90)
              .height(90)
              .objectFit(ImageFit.Cover)
              .borderRadius(12)
              .shadow({
                radius: 8,
                color: '#00000008',
                offsetX: 0,
                offsetY: 2
              })
              .margin({ top: 4, bottom: 8 })  // å¢åŠ å›¾ç‰‡ä¸Šä¸‹é—´è·
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .padding({ top: 10, bottom: 12 })  // å¢åŠ åº•éƒ¨padding
          .backgroundColor('#F8F9FA')
          .borderRadius(12)
        }

        // Timestamp
        if (this.currentData.timestamp) {
          Row() {
            Text('ğŸ•’')
              .fontSize(10)
              .margin({ right: 6 })
            
            Text(`Updated ${DataService.formatTime(this.currentData.timestamp)}`)
              .fontSize(11)
              .fontColor('#888888')
              .fontWeight(FontWeight.Medium)
          }
          .width('100%')
          .justifyContent(FlexAlign.End)
          .margin({ top: 8 })
          .opacity(0.7)
        }
      }
    }
  }







   @Builder
   statusContent() {
    Column({ space: 16 }) {
      // Animated loading indicator
      Stack() {
        Circle()
          .width(40)
          .height(40)
          .fill('#E8F5E9')
          .opacity(0.7)
        
        Circle()
          .width(40)
          .height(40)
          .stroke('#52C41A')
          .strokeWidth(2)
          .fill('#FFFFFF00')
        
        Text('ğŸ¤–')
          .fontSize(20)
      }
      
      Column({ space: 8 }) {
        // Skeleton text 1
        Row() {
          Row()
            .width(120)
            .height(12)
            .backgroundColor('#E0E0E0')
            .borderRadius(4)
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        
        // Skeleton text 2
        Row() {
          Row()
            .width(80)
            .height(12)
            .backgroundColor('#E0E0E0')
            .borderRadius(4)
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        
        // Status text
        Text('Waiting for smart actions...')
          .fontSize(13)
          .fontColor('#666666')
          .fontWeight(FontWeight.Medium)
          .textAlign(TextAlign.Center)
          .margin({ top: 8 })
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .padding({ top: 20, bottom: 20 })
  }

   private getStatusText(): string {
    return this.currentData ? 'Ready' : 'Connecting...';
  }

  private getActionNameBgColor(): string {
    if (!this.currentData?.action_data) {
      return '#F8F9FA';
    }
    const bgColor = DataService.getActionTypeLabelBgColor(this.currentData.action_data.action_type);
    // å°†é¢œè‰²è°ƒäº®ä¸€äº›ï¼Œä½œä¸ºä¸»ä¿¡æ¯èƒŒæ™¯
    switch (this.currentData.action_data.action_type) {
      case 'probe':
        return '#F0F9FF';  // æ›´æµ…çš„è“è‰²
      case 'recommend':
        return '#F6FFED';  // æ›´æµ…çš„ç»¿è‰²
      case 'none':
        return '#F5F5F5';  // æ›´æµ…çš„ç°è‰²
      default:
        return '#F8F9FA';
    }
  }

  private getActionTypeIcon(actionType: string): string {
    switch (actionType) {
      case 'probe':
        return 'ğŸ”';  // æ”¾å¤§é•œå›¾æ ‡
      case 'recommend':
        return 'ğŸ’¡';  // ç¯æ³¡å›¾æ ‡
      case 'none':
        return 'âšª';  // åœ†åœˆå›¾æ ‡
      default:
        return 'âš¡';  // é»˜è®¤é—ªç”µå›¾æ ‡
    }
  }

  private getActionTypeBorderColor(actionType: string): string {
    switch (actionType) {
      case 'probe':
        return '#1890FF';  // è“è‰²è¾¹æ¡†
      case 'recommend':
        return '#52C41A';  // ç»¿è‰²è¾¹æ¡†
      case 'none':
        return '#666666';  // ç°è‰²è¾¹æ¡†
      default:
        return '#D9D9D9';  // é»˜è®¤ç°è‰²
    }
  }

  private getActionTypeShortLabel(actionType: string): string {
    switch (actionType) {
      case 'probe':
        return 'Probe';
      case 'recommend':
        return 'Recommend';
      case 'none':
        return 'None';
      default:
        return 'Unknown';
    }
  }

  private getModuleLabel(activeModule: string): string {
    switch (activeModule) {
      case 'rule_engine':
        return '[Rule]';
      case 'dqn':
        return '[DQN]';
      case 'vlm':
        return '[VLM]';
      default:
        return '[Unknown]';
    }
  }

  private getModuleLabelBgColor(activeModule: string): string {
    switch (activeModule) {
      case 'rule_engine':
        return '#E0E0E0';
      case 'dqn':
        return '#E6F7FF';
      case 'vlm':
        return '#F9F0FF';
      default:
        return '#E0E0E0';
    }
  }

  private getModuleLabelTextColor(activeModule: string): string {
    switch (activeModule) {
      case 'rule_engine':
        return '#666666';
      case 'dqn':
        return '#1890FF';
      case 'vlm':
        return '#722ED1';
      default:
        return '#666666';
    }
  }
}
