# WebSocket连接测试指南

## 功能说明

已实现WebSocket连接功能，卡片可以：
1. 自动连接到服务器 `ws://0.0.0.0:8080/recommendation-stream`
2. 实时接收服务器推送的动作数据
3. 显示连接状态
4. 自动重连机制

## 测试步骤

### 1. 启动服务器
```bash
cd D:\proj\datapallet\app_server
python server.py
```

### 2. 安装并运行HarmonyOS应用
- 在DevEco Studio中构建并安装应用
- 添加卡片到桌面
- 卡片会自动尝试连接服务器

### 3. 发送测试数据
```bash
cd D:\proj\datapallet\app_server
python test.py
```

### 4. 观察卡片更新
- 卡片状态指示器：橙色(连接中) → 绿色(已连接)
- 收到数据后，卡片显示动作信息
- 再次发送测试数据，卡片内容更新

## 卡片状态说明

### 连接状态指示器
- 🟡 橙色：正在连接
- 🟢 绿色：已连接
- 🔴 红色：连接错误
- ⚪ 灰色：已断开

### 卡片交互
- **点击卡片**：
  - 断开状态：重新连接
  - 已连接状态：断开连接
  - 错误状态：重新连接

### 数据展示
- 连接成功后显示动作信息
- 包括：动作类型、动作名称、奖励值、描述、时间
- 奖励值显示为进度条

## 预期结果

1. ✅ 卡片自动连接到服务器
2. ✅ 状态指示器显示为绿色
3. ✅ 发送测试数据后卡片内容更新
4. ✅ 可以手动连接/断开
5. ✅ 连接断开后自动重连

## 故障排查

### 卡片显示"Connecting to server..."但一直不变
- 检查服务器是否启动
- 检查网络连接
- 检查服务器地址是否正确（0.0.0.0:8080）

### 卡片显示"Connection error"
- 服务器可能未启动
- 网络不可达
- 检查防火墙设置

### 发送测试数据后卡片不更新
- 检查服务器日志是否显示"数据已转发"
- 检查卡片是否显示"已连接"
- 尝试重新连接

### 点击卡片没有反应
- 检查连接状态
- 当前连接时点击会断开
- 当前断开时点击会重连

## 技术细节

### WebSocket端点
- URL: `ws://0.0.0.0:8080/recommendation-stream`
- 协议: WebSocket
- 单客户端模式：新连接替代旧连接

### 数据格式
```json
{
  "id": "rec_1736923200_001",
  "type": "recommend",
  "action": "transit_QR_code",
  "timestamp": 1736923200,
  "metadata": {
    "reward": 0.8,
    "description": "前方100米有地铁站，建议打开乘车码。"
  }
}
```

### 自动重连
- 最大重连次数: 5次
- 重连延迟: 指数退避 (1s, 2s, 4s, 8s, 16s)
- 最大延迟: 30秒

## 下一步

- 添加震动反馈功能
- 优化错误处理
- 添加更多动作类型支持